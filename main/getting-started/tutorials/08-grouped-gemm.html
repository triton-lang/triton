

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Group GEMM &mdash; Triton  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />

  
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Persistent Matmul" href="09-persistent-matmul.html" />
    <link rel="prev" title="Libdevice (tl.extra.libdevice) function" href="07-extern-functions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Triton
              <img src="https://cdn.openai.com/triton/assets/triton-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01-vector-add.html">Vector Addition</a></li>
<li class="toctree-l2"><a class="reference internal" href="02-fused-softmax.html">Fused Softmax</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-matrix-multiplication.html">Matrix Multiplication</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-low-memory-dropout.html">Low-Memory Dropout</a></li>
<li class="toctree-l2"><a class="reference internal" href="05-layer-norm.html">Layer Normalization</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-fused-attention.html">Fused Attention</a></li>
<li class="toctree-l2"><a class="reference internal" href="07-extern-functions.html">Libdevice (<cite>tl.extra.libdevice</cite>) function</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Group GEMM</a></li>
<li class="toctree-l2"><a class="reference internal" href="09-persistent-matmul.html">Persistent Matmul</a></li>
<li class="toctree-l2"><a class="reference internal" href="10-block-scaled-matmul.html">Block Scaled Matrix Multiplication</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../python-api/triton.html">triton</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python-api/triton.language.html">triton.language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python-api/triton.testing.html">triton.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python-api/triton-semantics.html">Triton Semantics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Triton MLIR Dialects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dialects/dialects.html">Triton MLIR Dialects and Ops</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Programming Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../programming-guide/chapter-1/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programming-guide/chapter-2/related-work.html">Related Work</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../programming-guide/chapter-3/debugging.html">Debugging Triton</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Triton</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Group GEMM</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/getting-started/tutorials/08-grouped-gemm.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-getting-started-tutorials-08-grouped-gemm-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="group-gemm">
<span id="sphx-glr-getting-started-tutorials-08-grouped-gemm-py"></span><h1>Group GEMM<a class="headerlink" href="#group-gemm" title="Link to this heading">Â¶</a></h1>
<p>This group gemm kernel launches a fixed number of CTA to compute a group
of gemms. The scheduling is static and we do it on device.</p>
<ul class="sphx-glr-horizontal">
<li><img src="../../_images/sphx_glr_08-grouped-gemm_001.png" srcset="../../_images/sphx_glr_08-grouped-gemm_001.png" alt="08 grouped gemm" class = "sphx-glr-multi-img"/></li>
<li><img src="../../_images/sphx_glr_08-grouped-gemm_002.png" srcset="../../_images/sphx_glr_08-grouped-gemm_002.png" alt="08 grouped gemm" class = "sphx-glr-multi-img"/></li>
</ul>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>group-gemm-performance:
        N    cuBLAS    Triton
0   128.0  0.022528  0.012288
1   256.0  0.025600  0.014336
2   512.0  0.033792  0.019456
3  1024.0  0.074752  0.072704
group-gemm-performance-m-8192-k-8192:
        M    cuBLAS    Triton
0   128.0  0.460800  0.503808
1   256.0  0.735232  0.868352
2   512.0  1.956864  1.768448
3  1024.0  2.749440  3.348992
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Copyright (c) 2023 - 2025 NVIDIA Corporation &amp; Affiliates. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person obtaining</span>
<span class="c1"># a copy of this software and associated documentation files</span>
<span class="c1"># (the &quot;Software&quot;), to deal in the Software without restriction,</span>
<span class="c1"># including without limitation the rights to use, copy, modify, merge,</span>
<span class="c1"># publish, distribute, sublicense, and/or sell copies of the Software,</span>
<span class="c1"># and to permit persons to whom the Software is furnished to do so,</span>
<span class="c1"># subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be</span>
<span class="c1"># included in all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="c1"># EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="c1"># MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.</span>
<span class="c1"># IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY</span>
<span class="c1"># CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,</span>
<span class="c1"># TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE</span>
<span class="c1"># SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">triton</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">triton.language</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tl</span>

<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">triton</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">get_active_torch_device</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">is_cuda</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">triton</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">get_current_target</span><span class="p">()</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;cuda&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">supports_tma</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">is_cuda</span><span class="p">()</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_capability</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">9</span>


<span class="k">def</span><span class="w"> </span><span class="nf">num_sms</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">is_cuda</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_properties</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">multi_processor_count</span>
    <span class="k">return</span> <span class="mi">148</span>


<span class="nd">@triton</span><span class="o">.</span><span class="n">autotune</span><span class="p">(</span>
    <span class="n">configs</span><span class="o">=</span><span class="p">[</span>
        <span class="n">triton</span><span class="o">.</span><span class="n">Config</span><span class="p">({</span>
            <span class="s1">&#39;BLOCK_SIZE_M&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_N&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_K&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
            <span class="s1">&#39;NUM_SM&#39;</span><span class="p">:</span> <span class="mi">84</span><span class="p">,</span>
        <span class="p">}),</span>
        <span class="n">triton</span><span class="o">.</span><span class="n">Config</span><span class="p">({</span>
            <span class="s1">&#39;BLOCK_SIZE_M&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_N&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_K&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
            <span class="s1">&#39;NUM_SM&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
        <span class="p">}),</span>
        <span class="n">triton</span><span class="o">.</span><span class="n">Config</span><span class="p">({</span>
            <span class="s1">&#39;BLOCK_SIZE_M&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_N&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_K&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
            <span class="s1">&#39;NUM_SM&#39;</span><span class="p">:</span> <span class="mi">84</span><span class="p">,</span>
        <span class="p">}),</span>
        <span class="n">triton</span><span class="o">.</span><span class="n">Config</span><span class="p">({</span>
            <span class="s1">&#39;BLOCK_SIZE_M&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_N&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_K&#39;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
            <span class="s1">&#39;NUM_SM&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
        <span class="p">}),</span>
        <span class="n">triton</span><span class="o">.</span><span class="n">Config</span><span class="p">({</span>
            <span class="s1">&#39;BLOCK_SIZE_M&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_N&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_K&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="s1">&#39;NUM_SM&#39;</span><span class="p">:</span> <span class="n">num_sms</span><span class="p">(),</span>
        <span class="p">}),</span>
        <span class="n">triton</span><span class="o">.</span><span class="n">Config</span><span class="p">({</span>
            <span class="s1">&#39;BLOCK_SIZE_M&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_N&#39;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
            <span class="s1">&#39;BLOCK_SIZE_K&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
            <span class="s1">&#39;NUM_SM&#39;</span><span class="p">:</span> <span class="n">num_sms</span><span class="p">(),</span>
        <span class="p">}),</span>
    <span class="p">],</span>
    <span class="n">key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group_size&#39;</span><span class="p">],</span>
<span class="p">)</span>
<span class="nd">@triton</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">grouped_matmul_kernel</span><span class="p">(</span>
    <span class="c1"># device tensor of matrices pointers</span>
    <span class="n">group_a_ptrs</span><span class="p">,</span>
    <span class="n">group_b_ptrs</span><span class="p">,</span>
    <span class="n">group_c_ptrs</span><span class="p">,</span>
    <span class="c1"># device tensor of gemm sizes. its shape is [group_size, 3]</span>
    <span class="c1"># dim 0 is group_size, dim 1 is the values of &lt;M, N, K&gt; of each gemm</span>
    <span class="n">group_gemm_sizes</span><span class="p">,</span>
    <span class="c1"># device tensor of leading dimension sizes. its shape is [group_size, 3]</span>
    <span class="c1"># dim 0 is group_size, dim 1 is the values of &lt;lda, ldb, ldc&gt; of each gemm</span>
    <span class="n">g_lds</span><span class="p">,</span>
    <span class="c1"># number of gemms</span>
    <span class="n">group_size</span><span class="p">,</span>
    <span class="c1"># number of virtual SM</span>
    <span class="n">NUM_SM</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">constexpr</span><span class="p">,</span>
    <span class="c1"># tile sizes</span>
    <span class="n">BLOCK_SIZE_M</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">constexpr</span><span class="p">,</span>
    <span class="n">BLOCK_SIZE_N</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">constexpr</span><span class="p">,</span>
    <span class="n">BLOCK_SIZE_K</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">constexpr</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">tile_idx</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">program_id</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">last_problem_end</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_size</span><span class="p">):</span>
        <span class="c1"># get the gemm size of the current problem</span>
        <span class="n">gm</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_gemm_sizes</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">gn</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_gemm_sizes</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">gk</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_gemm_sizes</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">num_m_tiles</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">cdiv</span><span class="p">(</span><span class="n">gm</span><span class="p">,</span> <span class="n">BLOCK_SIZE_M</span><span class="p">)</span>
        <span class="n">num_n_tiles</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">cdiv</span><span class="p">(</span><span class="n">gn</span><span class="p">,</span> <span class="n">BLOCK_SIZE_N</span><span class="p">)</span>
        <span class="n">num_tiles</span> <span class="o">=</span> <span class="n">num_m_tiles</span> <span class="o">*</span> <span class="n">num_n_tiles</span>
        <span class="c1"># iterate through the tiles in the current gemm problem</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">tile_idx</span> <span class="o">&gt;=</span> <span class="n">last_problem_end</span> <span class="ow">and</span> <span class="n">tile_idx</span> <span class="o">&lt;</span> <span class="n">last_problem_end</span> <span class="o">+</span> <span class="n">num_tiles</span><span class="p">):</span>
            <span class="c1"># pick up a tile from the current gemm problem</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">gk</span>
            <span class="n">lda</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">g_lds</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">ldb</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">g_lds</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ldc</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">g_lds</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">a_ptr</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_a_ptrs</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">pointer_type</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">float16</span><span class="p">))</span>
            <span class="n">b_ptr</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_b_ptrs</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">pointer_type</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">float16</span><span class="p">))</span>
            <span class="n">c_ptr</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_c_ptrs</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">pointer_type</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">float16</span><span class="p">))</span>
            <span class="c1"># figure out tile coordinates</span>
            <span class="n">tile_idx_in_gemm</span> <span class="o">=</span> <span class="n">tile_idx</span> <span class="o">-</span> <span class="n">last_problem_end</span>
            <span class="n">tile_m_idx</span> <span class="o">=</span> <span class="n">tile_idx_in_gemm</span> <span class="o">//</span> <span class="n">num_n_tiles</span>
            <span class="n">tile_n_idx</span> <span class="o">=</span> <span class="n">tile_idx_in_gemm</span> <span class="o">%</span> <span class="n">num_n_tiles</span>

            <span class="c1"># do regular gemm here</span>
            <span class="n">offs_am</span> <span class="o">=</span> <span class="n">tile_m_idx</span> <span class="o">*</span> <span class="n">BLOCK_SIZE_M</span> <span class="o">+</span> <span class="n">tl</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BLOCK_SIZE_M</span><span class="p">)</span>
            <span class="n">offs_bn</span> <span class="o">=</span> <span class="n">tile_n_idx</span> <span class="o">*</span> <span class="n">BLOCK_SIZE_N</span> <span class="o">+</span> <span class="n">tl</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BLOCK_SIZE_N</span><span class="p">)</span>
            <span class="n">offs_k</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BLOCK_SIZE_K</span><span class="p">)</span>
            <span class="n">a_ptrs</span> <span class="o">=</span> <span class="n">a_ptr</span> <span class="o">+</span> <span class="n">offs_am</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">lda</span> <span class="o">+</span> <span class="n">offs_k</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">b_ptrs</span> <span class="o">=</span> <span class="n">b_ptr</span> <span class="o">+</span> <span class="n">offs_k</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ldb</span> <span class="o">+</span> <span class="n">offs_bn</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">accumulator</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BLOCK_SIZE_M</span><span class="p">,</span> <span class="n">BLOCK_SIZE_N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tl</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tl</span><span class="o">.</span><span class="n">cdiv</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">BLOCK_SIZE_K</span><span class="p">)):</span>
                <span class="c1"># hint to Triton compiler to do proper loop pipelining</span>
                <span class="n">tl</span><span class="o">.</span><span class="n">multiple_of</span><span class="p">(</span><span class="n">a_ptrs</span><span class="p">,</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
                <span class="n">tl</span><span class="o">.</span><span class="n">multiple_of</span><span class="p">(</span><span class="n">b_ptrs</span><span class="p">,</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">])</span>
                <span class="c1"># assume full tile for now</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">a_ptrs</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">b_ptrs</span><span class="p">)</span>
                <span class="n">accumulator</span> <span class="o">+=</span> <span class="n">tl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">a_ptrs</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE_K</span>
                <span class="n">b_ptrs</span> <span class="o">+=</span> <span class="n">BLOCK_SIZE_K</span> <span class="o">*</span> <span class="n">ldb</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">accumulator</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

            <span class="n">offs_cm</span> <span class="o">=</span> <span class="n">tile_m_idx</span> <span class="o">*</span> <span class="n">BLOCK_SIZE_M</span> <span class="o">+</span> <span class="n">tl</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BLOCK_SIZE_M</span><span class="p">)</span>
            <span class="n">offs_cn</span> <span class="o">=</span> <span class="n">tile_n_idx</span> <span class="o">*</span> <span class="n">BLOCK_SIZE_N</span> <span class="o">+</span> <span class="n">tl</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BLOCK_SIZE_N</span><span class="p">)</span>
            <span class="n">c_ptrs</span> <span class="o">=</span> <span class="n">c_ptr</span> <span class="o">+</span> <span class="n">ldc</span> <span class="o">*</span> <span class="n">offs_cm</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">offs_cn</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># assumes full tile for now</span>
            <span class="n">tl</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">c_ptrs</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>

            <span class="c1"># go to the next tile by advancing NUM_SM</span>
            <span class="n">tile_idx</span> <span class="o">+=</span> <span class="n">NUM_SM</span>

        <span class="c1"># get ready to go to the next gemm problem</span>
        <span class="n">last_problem_end</span> <span class="o">=</span> <span class="n">last_problem_end</span> <span class="o">+</span> <span class="n">num_tiles</span>


<span class="k">def</span><span class="w"> </span><span class="nf">group_gemm_fn</span><span class="p">(</span><span class="n">group_A</span><span class="p">,</span> <span class="n">group_B</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_A</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_B</span><span class="p">)</span>
    <span class="n">group_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_A</span><span class="p">)</span>

    <span class="n">A_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">C_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g_sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g_lds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">group_C</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_size</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">group_A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">group_B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">M</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">K</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">group_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">A_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">B_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">C_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">g_sizes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">K</span><span class="p">]</span>
        <span class="n">g_lds</span> <span class="o">+=</span> <span class="p">[</span><span class="n">A</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">B</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">C</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>

    <span class="c1"># note these are device tensors</span>
    <span class="n">d_a_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">A_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_b_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">B_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_c_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">C_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_g_sizes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">g_sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_g_lds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">g_lds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="c1"># we use a fixed number of CTA, and it&#39;s auto-tunable</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">META</span><span class="p">:</span> <span class="p">(</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;NUM_SM&#39;</span><span class="p">],</span> <span class="p">)</span>
    <span class="n">grouped_matmul_kernel</span><span class="p">[</span><span class="n">grid</span><span class="p">](</span>
        <span class="n">d_a_ptrs</span><span class="p">,</span>
        <span class="n">d_b_ptrs</span><span class="p">,</span>
        <span class="n">d_c_ptrs</span><span class="p">,</span>
        <span class="n">d_g_sizes</span><span class="p">,</span>
        <span class="n">d_g_lds</span><span class="p">,</span>
        <span class="n">group_size</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">group_C</span>


<span class="n">tma_configs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">triton</span><span class="o">.</span><span class="n">Config</span><span class="p">({</span><span class="s1">&#39;BLOCK_SIZE_M&#39;</span><span class="p">:</span> <span class="n">BM</span><span class="p">,</span> <span class="s1">&#39;BLOCK_SIZE_N&#39;</span><span class="p">:</span> <span class="n">BN</span><span class="p">,</span> <span class="s1">&#39;BLOCK_SIZE_K&#39;</span> <span class="p">:</span> <span class="n">BK</span><span class="p">},</span> <span class="n">num_stages</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">num_warps</span><span class="o">=</span><span class="n">w</span><span class="p">)</span> \
    <span class="k">for</span> <span class="n">BM</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">128</span><span class="p">]</span>\
    <span class="k">for</span> <span class="n">BN</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">]</span>\
    <span class="k">for</span> <span class="n">BK</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>\
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>\
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>\
<span class="p">]</span>


<span class="nd">@triton</span><span class="o">.</span><span class="n">autotune</span><span class="p">(</span>
    <span class="n">tma_configs</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;group_a_ptrs&#39;</span><span class="p">,</span> <span class="s1">&#39;group_b_ptrs&#39;</span><span class="p">,</span> <span class="s1">&#39;gropup_c_ptrs&#39;</span><span class="p">,</span> <span class="s1">&#39;group_size&#39;</span><span class="p">],</span>
<span class="p">)</span>
<span class="nd">@triton</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">grouped_matmul_tma_kernel</span><span class="p">(</span>
    <span class="c1"># device tensor of matrices pointers</span>
    <span class="n">group_a_ptrs</span><span class="p">,</span>
    <span class="n">group_b_ptrs</span><span class="p">,</span>
    <span class="n">group_c_ptrs</span><span class="p">,</span>
    <span class="c1"># device tensor of gemm sizes. its shape is [group_size, 3]</span>
    <span class="c1"># dim 0 is group_size, dim 1 is the values of &lt;M, N, K&gt; of each gemm</span>
    <span class="n">group_gemm_sizes</span><span class="p">,</span>
    <span class="c1"># device tensor of leading dimension sizes. its shape is [group_size, 3]</span>
    <span class="c1"># dim 0 is group_size, dim 1 is the values of &lt;lda, ldb, ldc&gt; of each gemm</span>
    <span class="n">g_lds</span><span class="p">,</span>
    <span class="c1"># number of gemms</span>
    <span class="n">group_size</span><span class="p">,</span>
    <span class="c1"># number of virtual SM</span>
    <span class="n">NUM_SM</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">constexpr</span><span class="p">,</span>
    <span class="c1"># tile sizes</span>
    <span class="n">BLOCK_SIZE_M</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">constexpr</span><span class="p">,</span>
    <span class="n">BLOCK_SIZE_N</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">constexpr</span><span class="p">,</span>
    <span class="n">BLOCK_SIZE_K</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">constexpr</span><span class="p">,</span>
    <span class="c1"># is the output FP8 or FP16</span>
    <span class="n">FP8</span><span class="p">:</span> <span class="n">tl</span><span class="o">.</span><span class="n">constexpr</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">float8e4nv</span> <span class="k">if</span> <span class="n">FP8</span> <span class="k">else</span> <span class="n">tl</span><span class="o">.</span><span class="n">float16</span>
    <span class="n">tile_idx</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">program_id</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">last_problem_end</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_size</span><span class="p">):</span>
        <span class="c1"># get the gemm size of the current problem</span>
        <span class="n">gm</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_gemm_sizes</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">gn</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_gemm_sizes</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">gk</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_gemm_sizes</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">num_m_tiles</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">cdiv</span><span class="p">(</span><span class="n">gm</span><span class="p">,</span> <span class="n">BLOCK_SIZE_M</span><span class="p">)</span>
        <span class="n">num_n_tiles</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">cdiv</span><span class="p">(</span><span class="n">gn</span><span class="p">,</span> <span class="n">BLOCK_SIZE_N</span><span class="p">)</span>
        <span class="n">num_tiles</span> <span class="o">=</span> <span class="n">num_m_tiles</span> <span class="o">*</span> <span class="n">num_n_tiles</span>
        <span class="k">if</span> <span class="n">tile_idx</span> <span class="o">&gt;=</span> <span class="n">last_problem_end</span> <span class="ow">and</span> <span class="n">tile_idx</span> <span class="o">&lt;</span> <span class="n">last_problem_end</span> <span class="o">+</span> <span class="n">num_tiles</span><span class="p">:</span>
            <span class="c1"># pick up a tile from the current gemm problem</span>
            <span class="n">lda</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">g_lds</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">ldb</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">g_lds</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ldc</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">g_lds</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">a_ptr</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_a_ptrs</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">pointer_type</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
            <span class="n">b_ptr</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_b_ptrs</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">pointer_type</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
            <span class="n">c_ptr</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">group_c_ptrs</span> <span class="o">+</span> <span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">tl</span><span class="o">.</span><span class="n">pointer_type</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>

            <span class="n">a_desc</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">make_tensor_descriptor</span><span class="p">(</span>
                <span class="n">a_ptr</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">gm</span><span class="p">,</span> <span class="n">gk</span><span class="p">],</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="n">lda</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">block_shape</span><span class="o">=</span><span class="p">[</span><span class="n">BLOCK_SIZE_M</span><span class="p">,</span> <span class="n">BLOCK_SIZE_K</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="n">b_desc</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">make_tensor_descriptor</span><span class="p">(</span>
                <span class="n">b_ptr</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">gn</span><span class="p">,</span> <span class="n">gk</span><span class="p">],</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="n">ldb</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">block_shape</span><span class="o">=</span><span class="p">[</span><span class="n">BLOCK_SIZE_N</span><span class="p">,</span> <span class="n">BLOCK_SIZE_K</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">c_desc</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">make_tensor_descriptor</span><span class="p">(</span>
                <span class="n">c_ptr</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">gm</span><span class="p">,</span> <span class="n">gn</span><span class="p">],</span>
                <span class="n">strides</span><span class="o">=</span><span class="p">[</span><span class="n">ldc</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">block_shape</span><span class="o">=</span><span class="p">[</span><span class="n">BLOCK_SIZE_M</span><span class="p">,</span> <span class="n">BLOCK_SIZE_N</span><span class="p">],</span>
            <span class="p">)</span>

            <span class="c1"># iterate through the tiles in the current gemm problem</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">tile_idx</span> <span class="o">&gt;=</span> <span class="n">last_problem_end</span> <span class="ow">and</span> <span class="n">tile_idx</span> <span class="o">&lt;</span> <span class="n">last_problem_end</span> <span class="o">+</span> <span class="n">num_tiles</span><span class="p">):</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">gk</span>
                <span class="c1"># figure out tile coordinates</span>
                <span class="n">tile_idx_in_gemm</span> <span class="o">=</span> <span class="n">tile_idx</span> <span class="o">-</span> <span class="n">last_problem_end</span>
                <span class="n">tile_m_idx</span> <span class="o">=</span> <span class="n">tile_idx_in_gemm</span> <span class="o">//</span> <span class="n">num_n_tiles</span>
                <span class="n">tile_n_idx</span> <span class="o">=</span> <span class="n">tile_idx_in_gemm</span> <span class="o">%</span> <span class="n">num_n_tiles</span>

                <span class="c1"># do regular gemm here</span>
                <span class="n">offs_am</span> <span class="o">=</span> <span class="n">tile_m_idx</span> <span class="o">*</span> <span class="n">BLOCK_SIZE_M</span>
                <span class="n">offs_bn</span> <span class="o">=</span> <span class="n">tile_n_idx</span> <span class="o">*</span> <span class="n">BLOCK_SIZE_N</span>

                <span class="n">accumulator</span> <span class="o">=</span> <span class="n">tl</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BLOCK_SIZE_M</span><span class="p">,</span> <span class="n">BLOCK_SIZE_N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tl</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tl</span><span class="o">.</span><span class="n">cdiv</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">BLOCK_SIZE_K</span><span class="p">)):</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">a_desc</span><span class="o">.</span><span class="n">load</span><span class="p">([</span><span class="n">offs_am</span><span class="p">,</span> <span class="n">kk</span> <span class="o">*</span> <span class="n">BLOCK_SIZE_K</span><span class="p">])</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">b_desc</span><span class="o">.</span><span class="n">load</span><span class="p">([</span><span class="n">offs_bn</span><span class="p">,</span> <span class="n">kk</span> <span class="o">*</span> <span class="n">BLOCK_SIZE_K</span><span class="p">])</span>
                    <span class="n">accumulator</span> <span class="o">+=</span> <span class="n">tl</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

                <span class="n">offs_cm</span> <span class="o">=</span> <span class="n">tile_m_idx</span> <span class="o">*</span> <span class="n">BLOCK_SIZE_M</span>
                <span class="n">offs_cn</span> <span class="o">=</span> <span class="n">tile_n_idx</span> <span class="o">*</span> <span class="n">BLOCK_SIZE_N</span>

                <span class="n">c</span> <span class="o">=</span> <span class="n">accumulator</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
                <span class="n">c_desc</span><span class="o">.</span><span class="n">store</span><span class="p">([</span><span class="n">offs_cm</span><span class="p">,</span> <span class="n">offs_cn</span><span class="p">],</span> <span class="n">c</span><span class="p">)</span>

                <span class="c1"># go to the next tile by advancing NUM_SM</span>
                <span class="n">tile_idx</span> <span class="o">+=</span> <span class="n">NUM_SM</span>

        <span class="c1"># get ready to go to the next gemm problem</span>
        <span class="n">last_problem_end</span> <span class="o">=</span> <span class="n">last_problem_end</span> <span class="o">+</span> <span class="n">num_tiles</span>


<span class="k">def</span><span class="w"> </span><span class="nf">group_gemm_tma_fn</span><span class="p">(</span><span class="n">group_A</span><span class="p">,</span> <span class="n">group_B</span><span class="p">):</span>

    <span class="k">assert</span> <span class="n">supports_tma</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_A</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_B</span><span class="p">)</span>
    <span class="n">group_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_A</span><span class="p">)</span>

    <span class="n">A_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">C_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g_sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g_lds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">group_C</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_size</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">group_A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">group_B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">M</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">group_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">A_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">B_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">C_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">g_sizes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">K</span><span class="p">]</span>
        <span class="n">g_lds</span> <span class="o">+=</span> <span class="p">[</span><span class="n">A</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">B</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">C</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
    <span class="c1"># note these are device tensors</span>
    <span class="n">d_a_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">A_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_b_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">B_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_c_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">C_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_g_sizes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">g_sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_g_lds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">g_lds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>

    <span class="c1"># we use a fixed number of CTA, and it&#39;s auto-tunable</span>

    <span class="c1"># TMA descriptors require a global memory allocation</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">alloc_fn</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alignment</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">stream</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>

    <span class="n">triton</span><span class="o">.</span><span class="n">set_allocator</span><span class="p">(</span><span class="n">alloc_fn</span><span class="p">)</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">META</span><span class="p">:</span> <span class="p">(</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;NUM_SM&#39;</span><span class="p">],</span> <span class="p">)</span>
    <span class="n">grouped_matmul_tma_kernel</span><span class="p">[</span><span class="n">grid</span><span class="p">](</span><span class="n">d_a_ptrs</span><span class="p">,</span> <span class="n">d_b_ptrs</span><span class="p">,</span> <span class="n">d_c_ptrs</span><span class="p">,</span> <span class="n">d_g_sizes</span><span class="p">,</span> <span class="n">d_g_lds</span><span class="p">,</span> <span class="n">group_size</span><span class="p">,</span>
                                    <span class="n">FP8</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float8_e4m3fn</span> <span class="o">==</span> <span class="n">group_A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">NUM_SM</span><span class="o">=</span><span class="n">num_sms</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">group_C</span>


<span class="n">group_m</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
<span class="n">group_n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
<span class="n">group_k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">]</span>
<span class="n">group_A</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">group_B</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">group_B_T</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_m</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_n</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_n</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_k</span><span class="p">)</span>
<span class="n">group_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_m</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_size</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">group_m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">group_n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">group_k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
    <span class="n">B_T</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="n">group_A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">group_B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">group_B_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B_T</span><span class="p">)</span>

<span class="n">tri_out</span> <span class="o">=</span> <span class="n">group_gemm_fn</span><span class="p">(</span><span class="n">group_A</span><span class="p">,</span> <span class="n">group_B</span><span class="p">)</span>
<span class="n">ref_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">group_A</span><span class="p">,</span> <span class="n">group_B</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_size</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ref_out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tri_out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>

<span class="k">if</span> <span class="n">supports_tma</span><span class="p">():</span>
    <span class="n">tri_tma_out</span> <span class="o">=</span> <span class="n">group_gemm_tma_fn</span><span class="p">(</span><span class="n">group_A</span><span class="p">,</span> <span class="n">group_B_T</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_size</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ref_out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tri_tma_out</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">)</span>


<span class="c1"># only launch the kernel, no tensor preparation here to remove all overhead</span>
<span class="k">def</span><span class="w"> </span><span class="nf">triton_perf_fn</span><span class="p">(</span><span class="n">a_ptrs</span><span class="p">,</span> <span class="n">b_ptrs</span><span class="p">,</span> <span class="n">c_ptrs</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">lds</span><span class="p">,</span> <span class="n">group_size</span><span class="p">):</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">META</span><span class="p">:</span> <span class="p">(</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;NUM_SM&#39;</span><span class="p">],</span> <span class="p">)</span>
    <span class="n">grouped_matmul_kernel</span><span class="p">[</span><span class="n">grid</span><span class="p">](</span>
        <span class="n">a_ptrs</span><span class="p">,</span>
        <span class="n">b_ptrs</span><span class="p">,</span>
        <span class="n">c_ptrs</span><span class="p">,</span>
        <span class="n">sizes</span><span class="p">,</span>
        <span class="n">lds</span><span class="p">,</span>
        <span class="n">group_size</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">triton_tma_perf_fn</span><span class="p">(</span><span class="n">a_ptrs</span><span class="p">,</span> <span class="n">b_ptrs</span><span class="p">,</span> <span class="n">c_ptrs</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">lds</span><span class="p">,</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">META</span><span class="p">:</span> <span class="p">(</span><span class="n">META</span><span class="p">[</span><span class="s1">&#39;NUM_SM&#39;</span><span class="p">],</span> <span class="p">)</span>
    <span class="n">grouped_matmul_tma_kernel</span><span class="p">[</span><span class="n">grid</span><span class="p">](</span><span class="n">a_ptrs</span><span class="p">,</span> <span class="n">b_ptrs</span><span class="p">,</span> <span class="n">c_ptrs</span><span class="p">,</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">lds</span><span class="p">,</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">FP8</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float8_e4m3fn</span> <span class="o">==</span> <span class="n">dtype</span><span class="p">,</span>
                                    <span class="n">NUM_SM</span><span class="o">=</span><span class="n">num_sms</span><span class="p">())</span>


<span class="k">def</span><span class="w"> </span><span class="nf">torch_perf_fn</span><span class="p">(</span><span class="n">group_A</span><span class="p">,</span> <span class="n">group_B</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">group_A</span><span class="p">,</span> <span class="n">group_B</span><span class="p">):</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="nd">@triton</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">perf_report</span><span class="p">(</span>
    <span class="n">triton</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">Benchmark</span><span class="p">(</span>
        <span class="c1"># argument names to use as an x-axis for the plot</span>
        <span class="n">x_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span>
        <span class="n">x_vals</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">)],</span>  <span class="c1"># different possible values for `x_name`</span>
        <span class="n">line_arg</span><span class="o">=</span><span class="s1">&#39;provider&#39;</span><span class="p">,</span>
        <span class="c1"># argument name whose value corresponds to a different line in the plot</span>
        <span class="c1"># possible values for `line_arg``</span>
        <span class="n">line_vals</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cublas&#39;</span><span class="p">,</span> <span class="s1">&#39;triton&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;triton-tma&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">supports_tma</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="c1"># label name for the lines</span>
        <span class="n">line_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cuBLAS&quot;</span><span class="p">,</span> <span class="s2">&quot;Triton&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;Triton + TMA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">supports_tma</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="c1"># line styles</span>
        <span class="n">styles</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="p">([(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="n">supports_tma</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;runtime(ms)&quot;</span><span class="p">,</span>  <span class="c1"># label name for the y-axis</span>
        <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;group-gemm-performance&quot;</span><span class="p">,</span>
        <span class="c1"># name for the plot. Used also as a file name for saving the plot.</span>
        <span class="n">args</span><span class="o">=</span><span class="p">{},</span>
    <span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">benchmark_square_matrices</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
    <span class="n">group_size</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">group_A</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">group_B</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">group_B_T</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">A_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B_T_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">C_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g_sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g_lds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">group_C</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_size</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="n">B_T</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">group_A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">group_B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="n">group_B_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B_T</span><span class="p">)</span>
        <span class="n">group_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">A_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">B_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">B_T_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B_T</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">C_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">g_sizes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">]</span>
        <span class="n">g_lds</span> <span class="o">+=</span> <span class="p">[</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="p">]</span>

    <span class="n">d_a_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">A_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_b_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">B_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_b_t_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">B_T_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_c_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">C_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_g_sizes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">g_sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_g_lds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">g_lds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>

    <span class="n">quantiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;cublas&#39;</span><span class="p">:</span>
        <span class="n">ms</span><span class="p">,</span> <span class="n">min_ms</span><span class="p">,</span> <span class="n">max_ms</span> <span class="o">=</span> <span class="n">triton</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">do_bench</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">torch_perf_fn</span><span class="p">(</span><span class="n">group_A</span><span class="p">,</span> <span class="n">group_B</span><span class="p">),</span> <span class="n">quantiles</span><span class="o">=</span><span class="n">quantiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;triton&#39;</span><span class="p">:</span>
        <span class="n">ms</span><span class="p">,</span> <span class="n">min_ms</span><span class="p">,</span> <span class="n">max_ms</span> <span class="o">=</span> <span class="n">triton</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">do_bench</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">triton_perf_fn</span><span class="p">(</span><span class="n">d_a_ptrs</span><span class="p">,</span> <span class="n">d_b_ptrs</span><span class="p">,</span> <span class="n">d_c_ptrs</span><span class="p">,</span> <span class="n">d_g_sizes</span><span class="p">,</span> <span class="n">d_g_lds</span><span class="p">,</span> <span class="n">group_size</span><span class="p">),</span> <span class="n">quantiles</span><span class="o">=</span><span class="n">quantiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;triton-tma&#39;</span><span class="p">:</span>
        <span class="n">ms</span><span class="p">,</span> <span class="n">min_ms</span><span class="p">,</span> <span class="n">max_ms</span> <span class="o">=</span> <span class="n">triton</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">do_bench</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">triton_tma_perf_fn</span><span class="p">(</span><span class="n">d_a_ptrs</span><span class="p">,</span> <span class="n">d_b_t_ptrs</span><span class="p">,</span> <span class="n">d_c_ptrs</span><span class="p">,</span> <span class="n">d_g_sizes</span><span class="p">,</span> <span class="n">d_g_lds</span><span class="p">,</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span>
                                       <span class="n">float16</span><span class="p">),</span> <span class="n">quantiles</span><span class="o">=</span><span class="n">quantiles</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ms</span><span class="p">,</span> <span class="n">max_ms</span><span class="p">,</span> <span class="n">min_ms</span>


<span class="nd">@triton</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">perf_report</span><span class="p">(</span>
    <span class="n">triton</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">Benchmark</span><span class="p">(</span>
        <span class="c1"># argument names to use as an x-axis for the plot</span>
        <span class="n">x_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">],</span>
        <span class="n">x_vals</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="o">**</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">)],</span>  <span class="c1"># different possible values for `x_name`</span>
        <span class="n">line_arg</span><span class="o">=</span><span class="s1">&#39;provider&#39;</span><span class="p">,</span>
        <span class="c1"># argument name whose value corresponds to a different line in the plot</span>
        <span class="c1"># possible values for `line_arg``</span>
        <span class="n">line_vals</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cublas&#39;</span><span class="p">,</span> <span class="s1">&#39;triton&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;triton-tma&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">supports_tma</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="c1"># label name for the lines</span>
        <span class="n">line_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cuBLAS&quot;</span><span class="p">,</span> <span class="s2">&quot;Triton&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;Triton + TMA&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">supports_tma</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="c1"># line styles</span>
        <span class="n">styles</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="p">([(</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)]</span> <span class="k">if</span> <span class="n">supports_tma</span><span class="p">()</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;runtime(ms)&quot;</span><span class="p">,</span>  <span class="c1"># label name for the y-axis</span>
        <span class="n">plot_name</span><span class="o">=</span><span class="s2">&quot;group-gemm-performance-m-8192-k-8192&quot;</span><span class="p">,</span>
        <span class="c1"># name for the plot. Used also as a file name for saving the plot.</span>
        <span class="n">args</span><span class="o">=</span><span class="p">{},</span>
    <span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">benchmark_batches</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">provider</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">8192</span>
    <span class="n">K</span> <span class="o">=</span> <span class="mi">8192</span>
    <span class="n">group_size</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">group_A</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">group_B</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">group_B_T</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">A_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B_T_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">C_addrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g_sizes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g_lds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g_T_lds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">group_C</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group_size</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">K</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="n">B_T</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">group_A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">group_B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="n">group_B_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B_T</span><span class="p">)</span>
        <span class="n">group_C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="n">A_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">B_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">B_T_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">B_T</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">C_addrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">data_ptr</span><span class="p">())</span>
        <span class="n">g_sizes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">K</span><span class="p">]</span>
        <span class="n">g_lds</span> <span class="o">+=</span> <span class="p">[</span><span class="n">A</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">B</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">C</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
        <span class="n">g_T_lds</span> <span class="o">+=</span> <span class="p">[</span><span class="n">A</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">B_T</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">C</span><span class="o">.</span><span class="n">stride</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>

    <span class="n">d_a_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">A_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_b_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">B_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_b_t_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">B_T_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_c_ptrs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">C_addrs</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_g_sizes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">g_sizes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_g_lds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">g_lds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">d_g_t_lds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">g_T_lds</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>

    <span class="n">quantiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;cublas&#39;</span><span class="p">:</span>
        <span class="n">ms</span><span class="p">,</span> <span class="n">min_ms</span><span class="p">,</span> <span class="n">max_ms</span> <span class="o">=</span> <span class="n">triton</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">do_bench</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">torch_perf_fn</span><span class="p">(</span><span class="n">group_A</span><span class="p">,</span> <span class="n">group_B</span><span class="p">),</span> <span class="n">quantiles</span><span class="o">=</span><span class="n">quantiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;triton&#39;</span><span class="p">:</span>
        <span class="n">ms</span><span class="p">,</span> <span class="n">min_ms</span><span class="p">,</span> <span class="n">max_ms</span> <span class="o">=</span> <span class="n">triton</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">do_bench</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">triton_perf_fn</span><span class="p">(</span><span class="n">d_a_ptrs</span><span class="p">,</span> <span class="n">d_b_ptrs</span><span class="p">,</span> <span class="n">d_c_ptrs</span><span class="p">,</span> <span class="n">d_g_sizes</span><span class="p">,</span> <span class="n">d_g_lds</span><span class="p">,</span> <span class="n">group_size</span><span class="p">),</span> <span class="n">quantiles</span><span class="o">=</span><span class="n">quantiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">provider</span> <span class="o">==</span> <span class="s1">&#39;triton-tma&#39;</span><span class="p">:</span>
        <span class="n">ms</span><span class="p">,</span> <span class="n">min_ms</span><span class="p">,</span> <span class="n">max_ms</span> <span class="o">=</span> <span class="n">triton</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">do_bench</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">triton_tma_perf_fn</span><span class="p">(</span><span class="n">d_a_ptrs</span><span class="p">,</span> <span class="n">d_b_t_ptrs</span><span class="p">,</span> <span class="n">d_c_ptrs</span><span class="p">,</span> <span class="n">d_g_sizes</span><span class="p">,</span> <span class="n">d_g_t_lds</span><span class="p">,</span> <span class="n">group_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span>
                                       <span class="n">float16</span><span class="p">),</span> <span class="n">quantiles</span><span class="o">=</span><span class="n">quantiles</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ms</span><span class="p">,</span> <span class="n">max_ms</span><span class="p">,</span> <span class="n">min_ms</span>


<span class="n">benchmark_square_matrices</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">show_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">print_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">benchmark_batches</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">show_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">print_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 6.115 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-getting-started-tutorials-08-grouped-gemm-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/6360f3425f2c39f9f330971830c25ba7/08-grouped-gemm.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">08-grouped-gemm.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/28c32cf65cffdbedb0bbb3c70c8bd9a1/08-grouped-gemm.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">08-grouped-gemm.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/fecddac383ee03c4c47e2cf2ec91448a/08-grouped-gemm.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">08-grouped-gemm.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="07-extern-functions.html" class="btn btn-neutral float-left" title="Libdevice (tl.extra.libdevice) function" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="09-persistent-matmul.html" class="btn btn-neutral float-right" title="Persistent Matmul" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Philippe Tillet.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>